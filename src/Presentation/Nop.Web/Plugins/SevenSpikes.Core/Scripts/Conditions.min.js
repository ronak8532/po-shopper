/*
* Copyright 2016 Seven Spikes Ltd. All rights reserved. (http://www.nop-templates.com)
* http://www.nop-templates.com/t/licensinginfo
*/

function UpdateCondition(){var e=sevenSpikes.getHiddenValFromDom("#update-condition-url"),t=sevenSpikes.getHiddenValFromDom("#condition-id"),n=$("#condition *").serialize();n+="&conditionId="+t;var o={};o.__RequestVerificationToken=addAntiForgeryToken(),$.ajax({cache:!1,async:!1,type:"POST",data:n,url:e,success:function(){},headers:o,error:function(e,t,n){alert("Updating condition failed.")}})}function UpdateDefaultConditionStatement(){var e=sevenSpikes.getHiddenValFromDom("#update-default-condition-group-statement-url"),t=sevenSpikes.getHiddenValFromDom("#condition-id"),n=$("#DefaultConditionValue").find(":selected").val(),o={};o.__RequestVerificationToken=addAntiForgeryToken(),$.ajax({cache:!1,async:!1,type:"POST",data:{conditionId:t,defaultConditionStatementValue:n},url:e,success:function(){},headers:o,error:function(e,t,n){alert("Updating condition default group statement failed.")}})}function DisplayExistingConditions(){var e=$.parseJSON(sevenSpikes.getHiddenValFromDom("#condition-groups"));if(null!=e)for(var t=0;t<e.length;t++)AddConditionGroup(e[t])}function AddConditionGroup(e){if(e&&0!=e)AddConditionGroupGridHtml(e);else if(""==(e=CreateConditionGroupAndAddConditionGroupGridHtml()))return;addKendoGridForConditionGroup(e)}function addKendoGridForConditionGroup(a){var e="condition-group-grid-"+a,t=sevenSpikes.getHiddenValFromDom("#read-condition-group-url"),n=sevenSpikes.getHiddenValFromDom("#update-condition-statement-url"),o=sevenSpikes.getHiddenValFromDom("#destroy-condition-statement-url"),i=sevenSpikes.getHiddenValFromDom("#create-condition-statement-url"),r={},d=0,l=new kendo.data.DataSource({transport:{read:{url:t,cache:!1,dataType:"json",contentType:"application/json",data:addAntiForgeryToken},update:{url:n,type:"POST",dataType:"json",contentType:"application/json",data:addAntiForgeryToken},destroy:{url:o,cache:!1,dataType:"json",contentType:"application/json",data:addAntiForgeryToken},create:{url:i,type:"POST",dataType:"json",contentType:"application/json",data:addAntiForgeryToken},parameterMap:function(e,t){return"update"===t||"create"===t?kendo.stringify(r):"read"===t?{conditionGroupId:kendo.stringify(a)}:"destroy"===t?{conditionStatementId:kendo.stringify(d)}:void 0}},batch:!0,pageSize:sevenSpikes.getHiddenValFromDom("#defaultGridPageSize"),schema:{model:{id:"Id",fields:{ConditionType:{type:"text"},ConditionTypeId:{type:"number"},ConditionPropertyValue:{type:"number"},ConditionPropertyText:{type:"text"},OperatorTypeText:{type:"text"},OperatorTypeValue:{type:"number"},Text:{type:"text"},Value:{type:"text"}}}}});$("#"+e).kendoGrid({dataSource:l,pageable:{refresh:!0,pageSizes:sevenSpikes.getHiddenValFromDom("#gridPageSizes").split(",")},sortable:!0,editable:{mode:"popup",template:kendo.template($("#popup_editor").html()),window:{animation:!1,width:400}},edit:function(e){var t=e.model;null!=t.ConditionType&&null!=t.ConditionPropertyValue&&null!=t.OperatorTypeValue&&null!=t.Value&&($("#condition-type").attr("data-editValue",t.ConditionTypeId),$("#condition-property").attr("data-editValue",t.ConditionPropertyValue),$("#condition-operator").attr("data-editValue",t.OperatorTypeValue),$("#condition-value").attr("data-editValue",t.Value),$("#condition-num-value").attr("data-editValue",t.Value),$("#condition-text-value").attr("data-editValue",t.Value))},save:function(e){r.ConditionGroupId=a,r.ConditionTypeId=$("#condition-type").val(),r.ConditionPropertyValue=$("#condition-property").val(),r.OperatorTypeValue=$("#condition-operator").val();var t=$("#condition-value").parents(".k-dropdown").css("display"),n=$("#condition-num-value").parents(".k-numerictextbox").css("display"),o=$("#condition-text-value").css("display");if(t&&"none"==t?n&&"none"==n?o&&"none"==o||(r.Value=$("#condition-text-value").val()):r.Value=$("#condition-num-value").val():r.Value=$("#condition-value").val(),null!=e.model.ConditionType)for(var i=l.data(),d=0;d<i.length;d++)i[d].Id==e.model.Id&&(r.Id=e.model.Id,i[d].dirty=!0)},remove:function(e){if(null!=e.model.Id&&""!=e.model.Id)for(var t=l.data(),n=0;n<t.length;n++)t[n].Id==e.model.Id&&(d=e.model.Id,t[n].dirty=!0)},toolbar:["create","destroy"],columns:[{field:"Id",title:"Id",width:100,hidden:!0},{field:"ConditionType",title:"Type",width:100},{field:"ConditionPropertyText",title:"Property",width:100},{field:"OperatorTypeText",title:"OperatorType",width:100},{field:"Text",title:"Text",width:250},{field:"Value",title:"Value",width:200,hidden:!0},{command:["edit","destroy"],title:"&nbsp;",width:"150px"}]})}function DeleteConditionGroup(e,t){var n=sevenSpikes.getHiddenValFromDom("#delete-condition-group-url"),o={conditionGroupId:e},i={};i.__RequestVerificationToken=addAntiForgeryToken(),$.ajax({cache:!1,type:"POST",data:$.toJSON(o),contentType:"application/json; charset=utf-8",url:n,success:function(){$("#"+t).data("kendoGrid").destroy(),$("#"+t).parent().remove()},headers:i,error:function(e,t,n){alert("Deleting condition group failed.")}})}function AddViewModel(){var e=kendo.observable({typeSource:GetConditionTypes(),selectedType:null,selectedProperty:null,selectedOperator:null,selectedValue:null});e.selectedType=SetSelectedConditionType(e.typeSource),e.selectedProperty=SetSelectedConditionProperty(e.selectedType),e.selectedOperator=SetSelectedOperatorType(e.selectedProperty),e.selectedValue=function(){var e,t=$("#condition-value").parents(".k-dropdown").css("display"),n=$("#condition-num-value").parents(".k-numerictextbox").css("display"),o=$("#condition-text-value").css("display");return t&&"none"==t?n&&"none"==n?o&&"none"==o||(e=$("#condition-text-value").attr("data-editValue")):e=$("#condition-num-value").attr("data-editValue"):e=$("#condition-value").attr("data-editValue"),null!=e&&""!=e?e:null},kendo.bind($("#editor"),e)}function SetSelectedConditionType(e){var t=$("#condition-type").attr("data-editValue");if(null!=t&&""!=t)for(var n=0;n<e.length;n++)if(e[n].ConditionTypeId==t)return e[n];return null}function SetSelectedConditionProperty(e){var t=$("#condition-property").attr("data-editValue");if(null!=t&&""!=t)for(var n=0;n<e.ConditionProperties.length;n++)if(e.ConditionProperties[n].ConditionPropertyValue==t)return e.ConditionProperties[n];return null}function SetSelectedOperatorType(e){var t=$("#condition-operator").attr("data-editValue");if(null!=t&&""!=t)for(var n=0;n<e.Operators.length;n++)if(e.Operators[n].OperatorTypeValue==t)return e.Operators[n];return null}function GetConditionTypes(){var t,e=sevenSpikes.getHiddenValFromDom("#get-condition-type-url"),n=sevenSpikes.getHiddenValFromDom("#available-condition-types"),o={};return o.__RequestVerificationToken=addAntiForgeryToken(),$.ajax({cache:!1,async:!1,type:"POST",contentType:"application/json; charset=utf-8",data:$.toJSON({availableConditionTypesIds:n}),url:e,success:function(e){t=e},headers:o,error:function(e,t,n){alert("Retrieving condition types failed.")}}),t}function CreateConditionGroupAndAddConditionGroupGridHtml(){var e=sevenSpikes.getHiddenValFromDom("#create-condition-group-url"),t=sevenSpikes.getHiddenValFromDom("#condition-id");if(""==e||""==t)return 0;var n={conditionId:t},o={};o.__RequestVerificationToken=addAntiForgeryToken();var i="";return $.ajax({cache:!1,async:!1,type:"POST",headers:o,data:$.toJSON(n),contentType:"application/json; charset=utf-8",url:e,success:function(e){AddConditionGroupGridHtml(i=e)},error:function(e,t,n){alert("Creating new condition group failed.")}}),i}function AddConditionGroupGridHtml(e){var t='<div><div class="condition-group-grid" id="'+("condition-group-grid-"+e)+'" data-conditionGroupId="'+e+'"></div><div class="group-dependancy-text"><p>--OR--</p></div></div>';$("#condition-groups-wrapper").append(t)}$(document).ready(function(){DisplayExistingConditions(),$("a.add-condition-group").click(function(){AddConditionGroup()}),$(".k-grid-toolbar a.k-grid-delete").livequery("click",function(){var e=$(this).closest(".condition-group-grid");if(null!=e){var t=$(e).attr("data-conditionGroupId"),n=$(e).attr("id");null!=t&&null!=n&&DeleteConditionGroup(t,n)}}),$("#condition #ConditionName, #condition #Active").change(function(){UpdateCondition()}),$("#DefaultConditionValue").change(function(){UpdateDefaultConditionStatement()})}),$("#editor").livequery(function(){AddViewModel()}),$(window).unload(function(){var e=sevenSpikes.getHiddenValFromDom("#delete-unused-condition-groups-url"),t={conditionId:sevenSpikes.getHiddenValFromDom("#condition-id")},n={};n.__RequestVerificationToken=addAntiForgeryToken(),$.ajax({cache:!1,async:!1,type:"POST",data:$.toJSON(t),contentType:"application/json; charset=utf-8",url:e,success:function(){},headers:n,error:function(e,t,n){alert("Deleting condition failed.")}})});